with bsbw as (select bsbwart, dzins, tenamzl, tenamql, tenamtrg, weaid from PETR_S3_pdBA.bsbw_t bsbw),
     bum as (select weaid,bumgrundnam, bstid, namins, plnam, dzins from PETR_S3_pdBA.bum_t)

    select distinct
    wea.weanr, 
    substr(bsbw2.tenamzl, 1,3) lastwh,
    substr(bum.namins, instr(bum.namins, '/') + 1) namins,
    bum2.plnam,
    bsbw.tenamtrg,
    wea.dzins weacreated, 
    max(bum2.dzins) weacomplete,
    bsbw.dzins bstinserted,
    max(bsbw2.dzins) bstplacement,
    out.ifoutdzsnd weaclose
    
    from PETR_S3_pdBA.wea_t wea
        join PETR_S3_pdBA.wep_t wep on wea.weaid = wep.weaid
        left join bsbw bsbw on bsbw.weaid = wea.weaid and bsbwart = 40
        left join bsbw bsbw2 on bsbw2.weaid = wea.weaid and regexp_like(bsbw2.tenamzl, '^([0-9]){2}\D{1}')
        left join bum bum on bum.weaid = wea.weaid and bum.bumgrundnam = 'Lvs.Bum.BstAnl' -- положил на те но не закрыл
        left join bum bum2 on bum2.weaid = wea.weaid and bum2.bumgrundnam = 'Lvs.Bum.BstEinl' and bum2.bstid is not null -- закрыл те
        left join (select ifoutdzsnd, trim('|' from substr(ifoutdaten, -16)) as wea from PETR_S3_pdBA.ifout_t where ifoutmldnam = 'WMS.WEAEINLQUIT') out on out.wea = wea.weanr
    where wea.weaklanam in ('ZVT') and wea.weafsrsta != 600
    --   and wea.weaid like '%MPOST0000001023ZVT0'
    group by 
    wea.weanr, 
    substr(bsbw2.tenamzl, 1,3),
    wea.dzins,
    bum.namins,
    bsbw.dzins,
    bum2.plnam,
  --  bum2.dzins,
    bsbw.tenamtrg,
    out.ifoutdzsnd
    order by namins
    
