WITH 
auf AS (select * from PETR_S2_PDBA.auf_t),
aup AS (select * from PETR_S2_PDBA.aup_t),
bsbw AS (select * from PETR_S2_PDBA.bsbw_t),
art AS (select * from PETR_S2_PDBA.art_t),
tpahis AS (select * from PETR_S2_PDBA.tpahis_t),
txt AS (select * from PETR_S2_PDBA.txt_t)

select 
AUF as "Заказ",
case
when (CANSEL = 0 and auffsrsta = 100)  then 'Не отгружен' 
when CANSEL = 1 then 'Отменен'
else 'Отгружен'
end as "Статус",
CreateTime as "Время создания",
HostTime as "Выгрузка в ХОСТ",
Type as "Тип",
Wh as "Склад", 
Items as "Количество строк",
PPL as "Пополнение",
StartPick as "Начало сборки", 
EndPick as "Конец сборки", 
round((24 * 60 * (to_date(EndPick, 'HH24:MI') - to_date(StartPick, 'HH24:MI'))), 2) as "Время сборки",
StartPQ as "Начало контроля", 
EndPQ as "Конец контроля", 
case when StartPQ is not null and EndPQ is not null then round((24 * 60 * (to_date(EndPQ, 'HH24:MI') - to_date(StartPQ, 'HH24:MI'))), 2) end as "Время контроля",
CASE when StartCC is not null then StartCC end as "Начало колеровки", 
EndCC as "Конец колеровки", 
case when StartCC is not null and EndCC is not null then round((24 * 60 * (to_date(EndCC, 'HH24:MI') - to_date(StartCC, 'HH24:MI'))), 2) end as "Время колеровки",
VRS as "Отгружено в VRS", 
TOR as "Отгрузка в ворота", 
AUS as "Конец отгрузки",
round((24 * 60 * (to_date(AUS, 'HH24:MI') - to_date(StartPick, 'HH24:MI'))), 2) as "Общее время по складу",
case
when PlanTime > HostTime then 'Нет'
else 'Да'
end as "Опоздал"
from (
select DISTINCT
auf.aufnr as AUF, 
aufknzstorno as CANSEL,
CASE     WHEN AUANAM = 'RTK' THEN 'КЛИЕНТ'
                      WHEN AUANAM = 'RTD' THEN 'ДОСТАВКА'
                      WHEN AUANAM = 'SPI' THEN 'СПИСАНИЕ'
                      WHEN AUANAM = 'ZVP' THEN 'ПОСТАВЩИК'
                      WHEN AUANAM = 'RVP' THEN 'ПЕРЕМЕЩЕНИЕ'
                      WHEN AUANAM = 'RTZ' THEN 'ТЗ'
                      WHEN AUANAM = 'RTP' THEN 'СП'
                      WHEN AUANAM = 'RTI' THEN 'ИЗ' 
                      end as Type,
to_char(auf.dzins, 'HH24:MI / DD.MM.YYYY') as CreateTime,
to_char(auf.AufDzVsSoll, 'HH24:MI / DD.MM.YYYY') as PlanTime,
to_char(auf.aufdzhost,'HH24:MI / DD.MM.YYYY') as HostTime,
art.artelmsel as Wh,
count(distinct case when aup.aupbrmsel3 = art.artelmsel then aup.artid end) as Items,
min(case 
WHEN ((TPAHIS.tpastraphy = 'SLS' and TPAHIS.tpatypzulag = '10' and TPAHIS.tpatyplog = '30' and TPAHIS.plnamezl not like 'VRS%') and (to_char(tpahis.dzins, 'DD:MM') = to_char(auf.dzins, 'DD:MM'))) THEN to_char(TPAHIS.tpadzanl, 'HH24:MI')
end) as PPL,
min(CASE
WHEN  (bsbw.bsbwart = '60' and (bsbw.tenamzl is not null) or (bsbw.bsbwart = '20' and bsbw.plnamist like 'FZG%')) then to_char(bsbw.dzins, 'HH24:MI')
end) as StartPick,
min(CASE
WHEN (bsbw.bsbwart = '20' and bsbw.plnamist like 'PP%PQ%') or (bsbw.bsbwart = '20' and bsbw.plnamist like 'VRS%' and bsbw.plnamql like 'FZG%') then to_char(bsbw.dzins, 'HH24:MI')
end) as EndPick,
min(CASE
WHEN (bsbw.bsbwart = '20' and bsbw.plnamql like 'PP%PQ%' and bsbw.plnamist like 'PP%PW%') then to_char(bsbw.dzins, 'HH24:MI')
end) as StartPQ,
min(CASE
WHEN (bsbw.bsbwart = '20' and bsbw.plnamql like 'PP%PW%') then to_char(bsbw.dzins, 'HH24:MI')
end) as EndPQ,
min(CASE
WHEN (bsbw.bsbwart = '20' and bsbw.plnamist like 'CC%PQ%') then to_char(bsbw.dzins, 'HH24:MI')
end) as StartCC,
min(CASE
WHEN (bsbw.bsbwart = '20' and bsbw.plnamql like 'CC%PW%') then to_char(bsbw.dzins, 'HH24:MI')
end) as EndCC,
min(CASE
WHEN (bsbw.bsbwart = '20' and bsbw.plnamist like 'VRS%') then to_char(bsbw.dzins, 'HH24:MI')
end) as VRS,
min(CASE
WHEN (bsbw.bsbwart = '20' and bsbw.plnamist like 'TOR%') then to_char(bsbw.dzins, 'HH24:MI')
end) as TOR,
min(CASE
WHEN (bsbw.bsbwart = '20' and bsbw.plnamist like 'AUS%') then to_char(bsbw.dzins, 'HH24:MI')
end) as AUS,
auf.auffsrsta
from auf 
join aup on auf.aufid = aup.aufid
LEFT JOIN bsbw on auf.aufid = bsbw.aufid
LEFT JOIN art on art.artid = bsbw.artid
LEFT JOIN tpahis on bsbw.tenam = tpahis.tenam
LEFT JOIN txt on txt.TXTOBJID = auf.aufid and txt.TXTTABREF = 'AUF'
where 
auf.aufnr = :AUFNR or 
auf.aufnr = 'MAEH'||SUBSTR (:AUFNR,4,8)||:YEARPAR||auf.auanam||'0' or
auf.tournam = :AUFNR 
group by
aufnr, 
aufknzstorno,
auanam, 
aufanzaupbra,
artelmsel,
auf.dzins,
auf.aufdzhost,
auf.auffsrsta,
auf.AufDzVsSoll,
aufdzhost
order by art.artelmsel
)
