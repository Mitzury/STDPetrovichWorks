WITH 
AUF AS (SELECT * FROM PETR_S2_PDBA.AUF_T), 
AUP AS (SELECT* FROM PETR_S2_PDBA.AUP_T),
BSBW AS (SELECT * FROM PETR_S2_PDBA.BSBW_T),
ART AS (SELECT * FROM PETR_S2_PDBA.ART_T), 
TPAHIS AS (SELECT * FROM PETR_S2_PDBA.TPAHIS_T), 
TXT AS (SELECT * FROM PETR_S2_PDBA.TXT_T), 
TOUR AS (SELECT * FROM PETR_S2_PDBA.TOUR_T)

SELECT
    AUF AS "Заказ",
    CASE
        WHEN (CANSEL = 0 AND AUFFSRSTA = 100) THEN 'Не отгружен'
        WHEN CANSEL = 1 THEN 'Отменен'
        ELSE 'Отгружен'
    END        AS "Статус",
    CREATETIME AS "Время создания",
    HOSTTIME   AS "Выгрузка в ХОСТ",
    TYPE       AS "Тип",
    WH         AS "Склад",
    ITEMS      AS "Количество строк",
    PPL        AS "Пополнение",
    STARTPICK  AS "Начало сборки",
    ENDPICK    AS "Конец сборки",
    ROUND((24 * 60 * (TO_DATE(ENDPICK, 'HH24:MI') - TO_DATE(STARTPICK, 'HH24:MI'))),2) AS "Время сборки",
    STARTPQ    AS "Начало контроля",
    ENDPQ      AS "Конец контроля",
    CASE
        WHEN STARTPQ IS NOT NULL AND ENDPQ IS NOT NULL THEN
            ROUND((24 * 60 * (TO_DATE(ENDPQ, 'HH24:MI') - TO_DATE(STARTPQ, 'HH24:MI'))), 2)
    END        AS "Время контроля",
    CASE
        WHEN STARTCC IS NOT NULL THEN
            STARTCC
    END        AS "Начало колеровки",
    ENDCC      AS "Конец колеровки",
    CASE
        WHEN STARTCC IS NOT NULL AND ENDCC IS NOT NULL THEN
            ROUND((24 * 60 * (TO_DATE(ENDCC, 'HH24:MI') - TO_DATE(STARTCC, 'HH24:MI'))), 2)
    END        AS "Время колеровки",
    VRS        AS "Отгружено в VRS",
    TOR        AS "Отгрузка в ворота",
    AUS        AS "Конец отгрузки",
    ROUND((24 * 60 * (TO_DATE(AUS,
    'HH24:MI') - TO_DATE(STARTPICK,
    'HH24:MI'))),
    2)         AS "Общее время по складу",
    CASE
        WHEN PLANTIME > HOSTTIME THEN
            'Нет'
        ELSE
            'Да'
    END        AS "Опоздал"
FROM
    (
        SELECT
            DISTINCT AUF.AUFNR               AS AUF,
            AUFKNZSTORNO            AS CANSEL,
            CASE
                WHEN AUANAM = 'RTK' THEN 'КЛИЕНТ'
                WHEN AUANAM = 'RTD' THEN 'ДОСТАВКА'
                WHEN AUANAM = 'SPI' THEN 'СПИСАНИЕ'
                WHEN AUANAM = 'ZVP' THEN 'ПОСТАВЩИК'
                WHEN AUANAM = 'RVP' THEN 'ПЕРЕМЕЩЕНИЕ'
                WHEN AUANAM = 'RTZ' THEN 'ТЗ'
                WHEN AUANAM = 'RTP' THEN 'СП'
                WHEN AUANAM = 'RTI' THEN 'ИЗ'
            END AS TYPE,
            TO_CHAR(AUF.DZINS, 'HH24:MI / DD.MM.YYYY') AS CREATETIME,
            TO_CHAR(AUF.AUFDZVSSOLL, 'HH24:MI / DD.MM.YYYY') AS PLANTIME,
            TO_CHAR(AUF.AUFDZHOST, 'HH24:MI / DD.MM.YYYY') AS HOSTTIME,
            ART.ARTELMSEL AS WH,
            COUNT(DISTINCT CASE WHEN AUP.AUPBRMSEL3 = ART.ARTELMSEL THEN AUP.ARTID
            END) AS ITEMS,
            MIN(CASE
                WHEN ((TPAHIS.TPASTRAPHY = 'SLS'
                AND TPAHIS.TPATYPZULAG = '10'
                AND TPAHIS.TPATYPLOG = '30'
                AND TPAHIS.PLNAMEZL NOT LIKE 'VRS%')
                AND (TO_CHAR(TPAHIS.DZINS, 'DD:MM') = TO_CHAR(AUF.DZINS, 'DD:MM'))) THEN
                    TO_CHAR(TPAHIS.TPADZANL, 'HH24:MI')
            END)                    AS PPL,
            MIN(CASE
                WHEN (BSBW.BSBWART = '60'
                AND (BSBW.TENAMZL IS NOT NULL)
                OR (BSBW.BSBWART = '20'
                AND BSBW.PLNAMIST LIKE 'FZG%')) THEN
                    TO_CHAR(BSBW.DZINS, 'HH24:MI')
            END)                    AS STARTPICK,
            MIN(CASE
                WHEN (BSBW.BSBWART = '20'
                AND BSBW.PLNAMIST LIKE 'PP%PQ%') OR (BSBW.BSBWART = '20'
                AND BSBW.PLNAMIST LIKE 'VRS%'
                AND BSBW.PLNAMQL LIKE 'FZG%') THEN
                    TO_CHAR(BSBW.DZINS, 'HH24:MI')
            END)                    AS ENDPICK,
            MIN(CASE
                WHEN (BSBW.BSBWART = '20'
                AND BSBW.PLNAMQL LIKE 'PP%PQ%'
                AND BSBW.PLNAMIST LIKE 'PP%PW%') THEN
                    TO_CHAR(BSBW.DZINS, 'HH24:MI')
            END)                    AS STARTPQ,
            MIN(CASE
                WHEN (BSBW.BSBWART = '20'
                AND BSBW.PLNAMQL LIKE 'PP%PW%') THEN
                    TO_CHAR(BSBW.DZINS, 'HH24:MI')
            END)                    AS ENDPQ,
            MIN(CASE
                WHEN (BSBW.BSBWART = '20'
                AND BSBW.PLNAMIST LIKE 'CC%PQ%') THEN
                    TO_CHAR(BSBW.DZINS, 'HH24:MI')
            END)                    AS STARTCC,
            MIN(CASE
                WHEN (BSBW.BSBWART = '20'
                AND BSBW.PLNAMQL LIKE 'CC%PW%') THEN
                    TO_CHAR(BSBW.DZINS, 'HH24:MI')
            END)                    AS ENDCC,
            MIN(CASE
                WHEN (BSBW.BSBWART = '20'
                AND BSBW.PLNAMIST LIKE 'VRS%') THEN
                    TO_CHAR(BSBW.DZINS, 'HH24:MI')
            END)                    AS VRS,
            MIN(CASE
                WHEN (BSBW.BSBWART = '20'
                AND BSBW.PLNAMIST LIKE 'TOR%') THEN
                    TO_CHAR(BSBW.DZINS, 'HH24:MI')
            END)                    AS TOR,
            MIN(CASE
                WHEN (BSBW.BSBWART = '20'
                AND BSBW.PLNAMIST LIKE 'AUS%') THEN
                    TO_CHAR(BSBW.DZINS, 'HH24:MI')
            END)                    AS AUS,
            AUF.AUFFSRSTA
        FROM AUF
            JOIN AUP ON AUF.AUFID = AUP.AUFID 
            LEFT JOIN BSBWON AUF.AUFID = BSBW.AUFID
            LEFT JOIN ART ON ART.ARTID = BSBW.ARTID
            LEFT JOIN TPAHIS ON BSBW.TENAM = TPAHIS.TENAM
            LEFT JOIN TXT ON TXT.TXTOBJID = AUF.AUFID AND TXT.TXTTABREF = 'AUF'
            JOIN TOUR ON TOUR.TOURNAM = AUF.TOURNAM
        WHERE
            (LENGTH(:AUFNR) = 18 AND AUF.AUFNR = :AUFNR)
            OR (LENGTH(:AUFNR) = 11 AND AUF.AUFNR = 'MAEH'||SUBSTR (:AUFNR, 4, 8)||:YEAR||AUF.AUANAM||'0')
            OR (LENGTH(:AUFNR) = 10 AND AUF.TOURNAM = :AUFNR)
            OR (LENGTH(:AUFNR) < 10 AND TOUR.TOURINFO2 = :AUFNR)
        GROUP BY
            AUFNR, AUFKNZSTORNO, AUANAM, AUFANZAUPBRA, ARTELMSEL, AUF.DZINS, AUF.AUFDZHOST, AUF.AUFFSRSTA, AUF.AUFDZVSSOLL, AUFDZHOST
        ORDER BY
            ART.ARTELMSEL
    )
